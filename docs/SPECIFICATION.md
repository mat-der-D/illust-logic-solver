# イラストロジック自動ソルバー 仕様書

## 1. プロジェクト概要

### 1.1 システム名称
**Illust Logic Solver**（イラストロジック自動ソルバー）

### 1.2 目的と背景

イラストロジック（ノノグラム、お絵かきロジック、ピクロス等とも呼ばれる）は、論理的思考を要する魅力的なパズルである。しかし、難易度の高い問題では解答に多大な時間を要する場合がある。

本アプリケーションは以下の目的で開発される：

1. **解答の検証**: 難しい問題を自動的に解き、正解を確認できる
2. **問題作成の支援**: 自作したパズルが一意解を持つか検証できる

これにより、パズルを解く人は答え合わせができ、問題作成者は品質の高い問題を作成できるようになる。

### 1.3 想定ユーザー

- **パズル愛好家**: イラストロジックを解く際の答え合わせや、難問の解答確認を行いたい人
- **問題作成者**: オリジナルのイラストロジック問題を作成し、一意解の検証を行いたい人

---

## 2. 技術仕様

### 2.1 技術スタック

#### バックエンド
- **言語**: Rust 1.70+
- **フレームワーク**: Tauri 2.0+
- **主要クレート**:
  - `tauri`: Tauriフレームワーク本体
  - `serde`: データのシリアライズ/デシリアライズ
  - `serde_json`: JSON形式の処理

#### フロントエンド
- **言語**: TypeScript 5.0+
- **フレームワーク**: React 18+
- **スタイリング**: Tailwind CSS 3+
- **状態管理**: Zustand または Jotai
- **Tauri API**: `@tauri-apps/api`

#### 開発環境
- Node.js 18+
- パッケージマネージャー: pnpm（Tauri推奨）
- Tauri CLI
- 推奨エディタ: VSCode + Rust Analyzer + TypeScript拡張機能

### 2.2 対応プラットフォーム

- **Ubuntu** (Linux)
- **Windows** 10/11

### 2.3 配布形式

- インストーラー形式（各OS向け）
- ポータブル実行ファイル（オプション）

---

## 3. 機能要件

### 3.1 問題入力機能

#### 3.1.1 ヒント入力モード

ユーザーが問題のヒント（各行・各列の連続するマスの数）を手動で入力する機能。

**機能詳細**:
- グリッドサイズの設定（幅 × 高さ）
- 各行のヒント数値を入力（カンマ区切り、例: `2,1,3`）
- 各列のヒント数値を入力
- 入力内容のバリデーション（数値の妥当性チェック）
- リアルタイムでのグリッド表示更新

**入力制約**:
- 推奨サイズ: 50×50 まで
- 最大サイズ: 100×100
- 推奨サイズを超える場合は警告を表示

#### 3.1.2 ビジュアル作成モード

ユーザーがキャンバス上でマスを塗りつぶして絵を描き、自動的にヒントを生成する機能。

**機能詳細**:
- グリッドサイズの設定
- マスのクリック/ドラッグで塗りつぶし
- マスのクリックで塗りつぶし解除
- グリッド全体のクリア機能
- 塗りつぶした内容から自動的に行・列ヒントを生成
- 生成されたヒントの表示

**操作**:
- 左クリック: マスを塗る/消す
- ドラッグ: 連続して塗る/消す
- クリアボタン: 全マスをリセット

### 3.2 ソルバー機能

#### 3.2.1 自動解答

入力された問題を自動的に解く機能。

**機能詳細**:
- ワンクリックで完全自動解答
- 解答中の進捗表示（プログレスバー、または計算中メッセージ）
- 解答結果の3パターン表示:
  1. **一意解が存在**: 完全な解答グリッドを表示
  2. **複数解が存在**: 「この問題には複数の解が存在します」と表示
  3. **解が存在しない**: 「この問題には解が存在しません（矛盾しています）」と表示

**解答アルゴリズム**:
- 論理的推論による解法
- 推論のみで解けない場合はバックトラック（探索）を使用
- タイムアウト機能（後述）

#### 3.2.2 タイムアウト機能

長時間計算を防ぐための制限機能。

**機能詳細**:
- デフォルトタイムアウト: 60秒
- タイムアウト時間は設定画面で変更可能（10秒〜300秒）
- タイムアウト発生時のメッセージ表示: 「解答に時間がかかりすぎています。問題サイズを小さくするか、タイムアウト時間を延長してください。」
- 計算中断ボタンの提供（オプション）

### 3.3 一意解判定機能

問題作成者向けに、作成した問題が一意解を持つかを検証する機能。

**機能詳細**:
- 「一意解チェック」ボタンの実行
- ソルバーと同じロジックを使用
- 結果表示:
  - 一意解: 「この問題は一意解を持っています」+ 解答表示
  - 複数解: 「この問題は複数の解を持っています」（問題として不適切）
  - 解なし: 「この問題には解が存在しません」（矛盾している）

### 3.4 ファイル入出力機能

#### 3.4.1 ファイル形式

**JSON形式**を採用。

```json
{
  "version": "1.0",
  "width": 10,
  "height": 10,
  "rowHints": [
    [2, 1],
    [4],
    [1, 1],
    [2],
    [3, 1],
    [1, 1],
    [2, 2],
    [1],
    [3],
    [2, 1]
  ],
  "colHints": [
    [1, 2],
    [2, 1],
    [1, 1],
    [4],
    [1, 1],
    [2],
    [3, 1],
    [1, 1],
    [2, 2],
    [1]
  ],
  "metadata": {
    "title": "問題名（オプション）",
    "author": "作成者名（オプション）",
    "difficulty": "easy|medium|hard（オプション）",
    "createdAt": "2026-02-07T12:00:00Z（オプション）"
  }
}
```

**フィールド説明**:
- `version`: ファイルフォーマットのバージョン（将来の拡張用）
- `width`: グリッドの幅
- `height`: グリッドの高さ
- `rowHints`: 各行のヒント（配列の配列）
- `colHints`: 各列のヒント（配列の配列）
- `metadata`: 任意のメタデータ（問題名、作成者など）

#### 3.4.2 インポート機能

**機能詳細**:
- JSONファイルの読み込み
- ファイル形式のバリデーション
- エラーハンドリング（不正なJSONフォーマット、サイズ超過など）
- 読み込み成功時、グリッドとヒントを自動設定

**ファイル選択**:
- OSのファイル選択ダイアログを使用
- フィルタ: `*.json`

#### 3.4.3 エクスポート機能

**機能詳細**:
- 現在の問題（ヒント）をJSONファイルとして保存
- ファイル名の指定（デフォルト: `puzzle_YYYYMMDD_HHMMSS.json`）
- 保存場所の選択（OSのファイル保存ダイアログ）
- メタデータの入力（オプション）: 問題名、作成者名など

### 3.5 設定機能

#### 3.5.1 ソルバー設定

- **タイムアウト時間**: 10秒〜300秒（デフォルト: 60秒）
- **最大グリッドサイズ**: 変更可能（デフォルト: 100×100）
- **推奨サイズ警告**: 有効/無効（デフォルト: 有効）

#### 3.5.2 表示設定

- **グリッドの線の太さ**: 細い/標準/太い
- **セルのサイズ**: 小/中/大
- **配色**: ライト/ダーク（オプション、将来的に）

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

- **小サイズ問題（〜20×20）**: 1秒以内に解答
- **中サイズ問題（20×20〜50×50）**: 数秒〜数十秒以内
- **大サイズ問題（50×50〜100×100）**: タイムアウト時間内
- **UI応答性**: 操作に対して即座に反応（100ms以内）

### 4.2 ユーザビリティ要件

- **直感的なUI**: 初めてのユーザーでも操作方法が理解できる
- **エラーメッセージ**: 分かりやすく、解決方法を示す
- **進捗表示**: 長時間処理の際は進捗状況を表示
- **キーボードショートカット**: 主要な操作をキーボードで実行可能（オプション）

### 4.3 信頼性要件

- **入力バリデーション**: 不正な入力を事前にチェック
- **エラーハンドリング**: ファイル読み込み失敗、計算エラーなどを適切に処理
- **データの整合性**: 保存したファイルが確実に読み込める

---

## 5. UI設計

### 5.1 画面構成

#### 5.1.1 メインタブ: パズル（統合版）

ソルバー機能と問題作成機能を統合した画面。

```
┌─────────────────────────────────────────────────────────────┐
│ [パズル] [設定]                                              │
├─────────────────────────────────────────────────────────────┤
│ 入力モード: ○ ヒント入力  ○ ビジュアル作成                  │
│                                                              │
│ グリッドサイズ: 幅 [10] × 高さ [10]  [サイズ変更]          │
│                                                              │
├──────────────────┬──────────────────────────────────────────┤
│                  │          1  1  2                         │
│  行ヒント        │       1  2  1  1                         │
│                  │    ↓  ↓  ↓  ↓                          │
│  1: 2,1          │  1,1 →┌──┬──┬──┬──┐                    │
│  2: 4            │    4 →├──┼──┼──┼──┤                    │
│  3: 1,1          │  1,1 →├──┼──┼──┼──┤                    │
│  4: 2            │    2 →├──┼──┼──┼──┤                    │
│                  │       └──┴──┴──┴──┘                    │
│  [ヒント編集]    │                                          │
│                  │  ※ビジュアルモード時はクリックで塗る    │
│                  │                                          │
├──────────────────┴──────────────────────────────────────────┤
│ アクション:                                                  │
│ [ファイル読込] [ファイル保存]                                │
│ [解答を開始] [一意解チェック] [クリア]                      │
│                                                              │
│ 結果表示エリア:                                              │
│ ┌────────────────────────────────────────────────┐          │
│ │ （ここに解答結果やメッセージが表示される）      │          │
│ └────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

**要素説明**:

1. **入力モード切り替え**: ラジオボタンで「ヒント入力」と「ビジュアル作成」を切り替え
2. **グリッドサイズ入力**: 幅と高さを数値入力、「サイズ変更」ボタンで適用
3. **左側パネル**: 各行のヒント表示・編集
4. **中央パネル**: グリッドの表示（ヒント入力モード時は表示のみ、ビジュアルモード時は編集可能）
5. **上部**: 各列のヒント表示
6. **アクションボタン**: ファイル操作、解答実行、クリア
7. **結果表示エリア**: 解答結果やエラーメッセージを表示

#### 5.1.2 設定タブ

```
┌─────────────────────────────────────────────────────────────┐
│ [パズル] [設定]                                              │
├─────────────────────────────────────────────────────────────┤
│ ソルバー設定                                                 │
│ ┌─────────────────────────────────────────────┐             │
│ │ タイムアウト時間: [60] 秒                   │             │
│ │ 最大グリッドサイズ: [100] × [100]          │             │
│ │ 推奨サイズ警告を表示: ☑ 有効                │             │
│ └─────────────────────────────────────────────┘             │
│                                                              │
│ 表示設定                                                     │
│ ┌─────────────────────────────────────────────┐             │
│ │ グリッドの線の太さ: [標準 ▼]               │             │
│ │ セルのサイズ: [中 ▼]                        │             │
│ └─────────────────────────────────────────────┘             │
│                                                              │
│ [デフォルトに戻す] [保存]                                    │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 操作フロー

#### 5.2.1 問題を解くフロー（ヒント入力モード）

1. 「パズル」タブを開く
2. 入力モードで「ヒント入力」を選択
3. グリッドサイズを設定
4. 各行・列のヒントを入力
5. 「解答を開始」ボタンをクリック
6. 結果表示エリアに解答が表示される

#### 5.2.2 問題を作成して検証するフロー（ビジュアルモード）

1. 「パズル」タブを開く
2. 入力モードで「ビジュアル作成」を選択
3. グリッドサイズを設定
4. キャンバス上でマスをクリックして絵を描く
5. ヒントが自動生成される
6. 「一意解チェック」ボタンをクリック
7. 結果表示エリアに判定結果が表示される
8. （オプション）「ファイル保存」で問題を保存

#### 5.2.3 ファイルから問題を読み込むフロー

1. 「ファイル読込」ボタンをクリック
2. ファイル選択ダイアログでJSONファイルを選択
3. 問題が自動的にロードされ、グリッドとヒントが表示される
4. 「解答を開始」で解答

### 5.3 結果表示の詳細

#### 一意解が見つかった場合

```
┌────────────────────────────────────────────────┐
│ ✓ 一意解が見つかりました                       │
│                                                │
│ 解答グリッド:                                  │
│ ┌──────────────┐                              │
│ │ ■□■□■      │                              │
│ │ □■■■□      │                              │
│ │ ■□■□■      │                              │
│ │ □□■■□      │                              │
│ └──────────────┘                              │
│                                                │
│ 計算時間: 0.45秒                               │
│                                                │
│ [結果を保存] [閉じる]                          │
└────────────────────────────────────────────────┘
```

#### 複数解がある場合

```
┌────────────────────────────────────────────────┐
│ ⚠ この問題には複数の解が存在します            │
│                                                │
│ この問題は一意解を持たないため、              │
│ パズルとして適切ではありません。              │
│                                                │
│ 計算時間: 1.23秒                               │
│                                                │
│ [閉じる]                                       │
└────────────────────────────────────────────────┘
```

#### 解が存在しない場合

```
┌────────────────────────────────────────────────┐
│ ✗ この問題には解が存在しません                │
│                                                │
│ ヒントに矛盾があるため、                      │
│ 解答不可能な問題です。                        │
│                                                │
│ 計算時間: 0.12秒                               │
│                                                │
│ [閉じる]                                       │
└────────────────────────────────────────────────┘
```

#### タイムアウトした場合

```
┌────────────────────────────────────────────────┐
│ ⏱ 解答に時間がかかりすぎています              │
│                                                │
│ この問題は複雑すぎるため、制限時間内に        │
│ 解答できませんでした。                        │
│                                                │
│ 対処方法:                                      │
│ - 問題サイズを小さくする                      │
│ - 設定でタイムアウト時間を延長する            │
│                                                │
│ [閉じる]                                       │
└────────────────────────────────────────────────┘
```

---

## 6. データ仕様

### 6.1 問題データの構造

#### JSONスキーマ

```typescript
interface PuzzleData {
  version: string;           // フォーマットバージョン（例: "1.0"）
  width: number;             // グリッドの幅（1〜100）
  height: number;            // グリッドの高さ（1〜100）
  rowHints: number[][];      // 各行のヒント
  colHints: number[][];      // 各列のヒント
  metadata?: {               // オプションのメタデータ
    title?: string;          // 問題名
    author?: string;         // 作成者
    difficulty?: "easy" | "medium" | "hard";  // 難易度
    createdAt?: string;      // 作成日時（ISO 8601形式）
  };
}
```

#### バリデーションルール

1. `width`, `height`: 1以上、100以下の整数
2. `rowHints`: 配列の長さは`height`と一致
3. `colHints`: 配列の長さは`width`と一致
4. 各ヒント配列: 空でも可（すべて空白の行/列）
5. ヒントの各数値: 1以上の整数
6. ヒントの合計値: 対応する行/列のサイズを超えない（空白を考慮）

### 6.2 内部データ構造（Rust側）

```rust
// Rustでの問題データ表現（参考）
#[derive(Serialize, Deserialize, Debug)]
struct PuzzleData {
    version: String,
    width: usize,
    height: usize,
    row_hints: Vec<Vec<u32>>,
    col_hints: Vec<Vec<u32>>,
    metadata: Option<PuzzleMetadata>,
}

#[derive(Serialize, Deserialize, Debug)]
struct PuzzleMetadata {
    title: Option<String>,
    author: Option<String>,
    difficulty: Option<Difficulty>,
    created_at: Option<String>,
}

#[derive(Serialize, Deserialize, Debug)]
enum Difficulty {
    Easy,
    Medium,
    Hard,
}
```

### 6.3 グリッドの状態表現

解答グリッド（内部的な表現）:

```rust
// セルの状態
enum CellState {
    Unknown,   // 未確定
    Filled,    // 塗りつぶし
    Empty,     // 空白
}

// グリッド全体
type Grid = Vec<Vec<CellState>>;
```

---

## 7. 用語集

### 7.1 イラストロジック関連用語

- **イラストロジック（Illustration Logic）**: 論理パズルの一種。別名: ノノグラム、お絵かきロジック、ピクロス、Nonogram
- **グリッド（Grid）**: マス目の集合。パズルの盤面
- **セル（Cell）**: グリッド内の1つのマス
- **ヒント（Hint/Clue）**: 各行・各列に与えられる数値。連続して塗りつぶされるセルの数を示す
- **一意解（Unique Solution）**: パズルの解答が唯一つに定まること
- **複数解（Multiple Solutions）**: パズルに複数の解答が存在すること（パズルとして不適切）

### 7.2 システム用語

- **ソルバー（Solver）**: パズルを自動的に解くアルゴリズム・機能
- **バックトラック（Backtracking）**: 試行錯誤による探索アルゴリズム
- **タイムアウト（Timeout）**: 計算時間の制限
- **エクスポート（Export）**: データをファイルに保存すること
- **インポート（Import）**: ファイルからデータを読み込むこと

---

## 8. 実装の優先順位

### Phase 1: 基本機能（MVP）

1. ヒント入力モードの実装
2. 基本的なソルバーアルゴリズム（論理的推論）
3. 一意解/複数解/解なしの判定
4. 結果表示
5. 基本的なUI（グリッド表示、ヒント入力）

### Phase 2: ファイル機能

1. JSON形式のインポート/エクスポート
2. ファイル入出力のエラーハンドリング

### Phase 3: 問題作成機能

1. ビジュアル作成モードの実装
2. キャンバスでの塗りつぶし機能
3. ヒント自動生成
4. 一意解チェック機能

### Phase 4: 最適化と追加機能

1. バックトラックアルゴリズムの最適化
2. タイムアウト機能
3. 進捗表示
4. 設定画面
5. 表示カスタマイズ

### Phase 5: 品質向上（将来的）

1. キーボードショートカット
2. ダークモード
3. 問題の難易度推定機能
4. 解答手順のステップ表示（教育用）

---

## 9. 今後の拡張可能性

以下は現バージョンでは実装しないが、将来的に検討可能な機能：

- **カラーイラストロジック**: 複数色を使ったパズル
- **問題ライブラリ**: アプリ内に問題集を内蔵
- **オンライン共有**: 問題をクラウド経由で共有
- **統計機能**: 解いた問題数、平均解答時間などの記録
- **ヒントモード**: ユーザーが途中まで解いた状態から次の1手を教える
- **ステップ実行**: 解答プロセスを1手ずつ確認できる
- **画像からの問題生成**: 画像をアップロードして自動的に問題化

---

## 10. 参考資料

### 10.1 イラストロジックについて

- パズルのルール: https://en.wikipedia.org/wiki/Nonogram
- ソルバーアルゴリズムの参考: 論理的推論 + バックトラック探索

### 10.2 技術参考

- Tauri公式ドキュメント: https://tauri.app/
- React公式ドキュメント: https://react.dev/
- Tailwind CSS公式ドキュメント: https://tailwindcss.com/

---

## 11. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-02-07 | 初版作成 |

---

**作成日**: 2026年2月7日
**最終更新日**: 2026年2月7日
**ステータス**: 承認待ち
